<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>I人夜店 | Introvert's Night</title>
    <!-- 引入自訂樣式 -->
    <link rel="stylesheet" href="styles.css" />
    <!-- SheetJS 用於匯出 Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  </head>
  <body>
    <div id="loading"><div class="spinner"></div></div>

    <!-- 自定義提示框 -->
    <div id="toast" class="toast">
      <div class="toast-content">
        <span id="toast-message"></span>
      </div>
    </div>

    <!-- 自定義密碼輸入框 -->
    <div id="password-modal" class="modal">
      <div class="modal-content">
        <h3 style="margin-top: 0; margin-bottom: 15px">請輸入管理員密碼</h3>
        <form
          id="password-form"
          name="password-form"
          onsubmit="event.preventDefault(); document.getElementById('password-submit').click();"
        >
          <input
            type="password"
            id="password-input"
            name="password"
            placeholder="輸入密碼"
            autocomplete="current-password"
            form="password-form"
            style="
              width: 100%;
              padding: 12px;
              background: #333;
              color: white;
              border: 1px solid #444;
              border-radius: 6px;
              margin-bottom: 15px;
              box-sizing: border-box;
              font-size: 16px;
            "
          />
          <div style="display: flex; gap: 10px">
            <button
              type="submit"
              class="btn"
              id="password-submit"
              form="password-form"
              style="flex: 1; margin: 0"
            >
              確認
            </button>
            <button
              type="button"
              class="btn outline"
              id="password-cancel"
              style="flex: 1; margin: 0"
            >
              取消
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 自定義確認對話框 -->
    <div id="confirm-modal" class="modal">
      <div class="modal-content">
        <h3 style="margin-top: 0; margin-bottom: 15px" id="confirm-title">
          確認
        </h3>
        <p
          id="confirm-message"
          style="margin-bottom: 20px; line-height: 1.6"
        ></p>
        <div style="display: flex; gap: 10px">
          <button class="btn" id="confirm-ok" style="flex: 1; margin: 0">
            確認
          </button>
          <button
            class="btn outline"
            id="confirm-cancel"
            style="flex: 1; margin: 0"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <!-- 區域編輯模态框 -->
    <div id="zone-edit-modal" class="modal">
      <div
        class="modal-content"
        style="max-width: 600px; max-height: 90vh; overflow-y: auto"
      >
        <h3 style="margin-top: 0; margin-bottom: 15px" id="zone-edit-title">
          編輯區域內容
        </h3>
        <div style="margin-bottom: 15px">
          <label
            style="
              display: block;
              margin-bottom: 5px;
              font-size: 14px;
              color: #aaa;
            "
            >狀態：</label
          >
          <textarea
            id="zone-edit-status"
            placeholder="例如：你今天的能量適合交朋友嗎？那就大膽選擇這區吧！"
            class="hide-scrollbar"
            style="
              width: 100%;
              min-height: 60px;
              padding: 10px;
              background: #333;
              color: white;
              border: 1px solid #444;
              border-radius: 6px;
              box-sizing: border-box;
              font-size: 14px;
              font-family: inherit;
              resize: vertical;
              overflow-y: auto;
              scrollbar-width: none;
              -ms-overflow-style: none;
            "
          ></textarea>
        </div>
        <div style="margin-bottom: 15px">
          <label
            style="
              display: block;
              margin-bottom: 5px;
              font-size: 14px;
              color: #aaa;
            "
            >任務：</label
          >
          <textarea
            id="zone-edit-task"
            placeholder="例如：桌子的中間有療癒卡，請誠心的回想自己最近的狀態，並抽取一張小卡..."
            class="hide-scrollbar"
            style="
              width: 100%;
              min-height: 80px;
              padding: 10px;
              background: #333;
              color: white;
              border: 1px solid #444;
              border-radius: 6px;
              box-sizing: border-box;
              font-size: 14px;
              font-family: inherit;
              resize: vertical;
              overflow-y: auto;
              scrollbar-width: none;
              -ms-overflow-style: none;
            "
          ></textarea>
        </div>
        <div style="margin-bottom: 20px">
          <label
            style="
              display: block;
              margin-bottom: 5px;
              font-size: 14px;
              color: #aaa;
            "
            >提醒：</label
          >
          <textarea
            id="zone-edit-reminder"
            placeholder="例如：有時候突破是需要一點勇氣，而今天的你選擇這裡就已充滿勇氣..."
            class="hide-scrollbar"
            style="
              width: 100%;
              min-height: 80px;
              padding: 10px;
              background: #333;
              color: white;
              border: 1px solid #444;
              border-radius: 6px;
              box-sizing: border-box;
              font-size: 14px;
              font-family: inherit;
              resize: vertical;
              overflow-y: auto;
              scrollbar-width: none;
              -ms-overflow-style: none;
            "
          ></textarea>
        </div>
        <div style="display: flex; gap: 10px">
          <button class="btn" id="zone-edit-save" style="flex: 1; margin: 0">
            儲存
          </button>
          <button
            class="btn outline"
            id="zone-edit-cancel"
            style="flex: 1; margin: 0"
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <!-- 所有座位查看模态框 -->
    <div id="seats-modal" class="modal">
      <div
        class="modal-content"
        style="
          max-width: 480px;
          width: 85%;
          max-height: 90vh;
          overflow-y: auto;
          padding: 15px;
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
          "
        >
          <button
            class="btn outline"
            onclick="closeSeatsModal()"
            style="margin: 0; padding: 6px 12px; font-size: 11px"
          >
            關閉
          </button>
        </div>
        <div
          id="admin-seats-list"
          class="hide-scrollbar"
          style="max-height: calc(90vh - 100px); overflow-y: auto; padding: 0"
        ></div>
      </div>
    </div>

    <div id="app">
      <!-- 頁面 1: 報到 -->
      <div id="p-checkin" class="page active">
        <h1>
          I 人夜店<br /><span style="font-size: 14px; color: #888"
            >INTROVERT'S NIGHT</span
          >
        </h1>
        <p style="text-align: center; margin-bottom: 30px">
          請選擇您的報到名稱
        </p>
        <div id="user-list"></div>

        <!-- 查看位置表功能 -->
        <div
          style="
            margin-top: 30px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid #333;
          "
        >
          <p
            style="
              text-align: center;
              font-size: 12px;
              color: #888;
              margin-bottom: 15px;
            "
          >
            已報到？輸入名稱查看位置表
          </p>
          <input
            type="text"
            id="check-seat-name"
            placeholder="輸入您的報到名稱"
            onkeypress="if(event.key === 'Enter') checkNameAndGoToZones()"
            style="
              width: 100%;
              padding: 12px;
              background: #333;
              color: white;
              border: 1px solid #444;
              border-radius: 6px;
              margin-bottom: 10px;
              box-sizing: border-box;
              font-size: 14px;
            "
          />
          <button
            class="btn outline"
            onclick="checkNameAndGoToZones()"
            style="width: 100%; padding: 12px; font-size: 14px"
          >
            查看位置表
          </button>
        </div>

        <!-- 明顯的 Staff 入口 -->
        <div class="staff-entry">
          <span class="staff-link" onclick="promptAdmin()">Staff Only</span>
        </div>
      </div>

      <!-- 頁面 2: 支付 -->
      <div id="p-payment" class="page">
        <h1>支付門票</h1>
        <div
          style="
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #333;
            margin-bottom: 20px;
          "
        >
          <p>門票費用：<strong>$350</strong></p>
          <p style="font-size: 12px; color: #666">
            請至櫃台掃描 LinePay 或支付現金
          </p>
        </div>
        <!-- <p style="text-align: center; font-size: 12px; color: #888">
          請向工作人員出示此畫面<br />確認支付完成
        </p> -->
        <button class="btn staff" id="btn-staff-confirm">
          【工作人員點擊】支付完成
        </button>
        <button class="btn outline" onclick="showPage('p-checkin')">
          返回
        </button>
      </div>

      <!-- 頁面 3: 區域介紹 -->
      <div id="p-zones" class="page">
        <h2>選擇您的棲息地</h2>
        <p
          style="
            text-align: center;
            font-size: 16px;
            color: #888;
            margin-bottom: 20px;
          "
        >
          請移動你的腳步<br />跟隨分區說明<br />尋找最適合的位置
        </p>
        <!-- 滑動容器 -->
        <div
          id="zone-swiper-wrapper"
          style="
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
          "
        >
          <div
            id="zone-container"
            style="
              display: flex;
              transition: transform 0.3s ease;
              will-change: transform;
            "
          ></div>
        </div>
        <!-- 區域指示器 -->
        <div
          id="zone-indicators"
          style="
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
          "
        ></div>
      </div>

      <!-- 頁面 4: 選位 -->
      <div id="p-seat" class="page">
        <h2 id="seat-zone-title">區域選擇</h2>
        <p style="text-align: center; font-size: 14px">請點擊圓圈選擇座位</p>
        <div class="seat-grid" id="seat-grid"></div>
        <p
          style="
            font-size: 12px;
            color: var(--danger);
            margin-top: 20px;
            text-align: center;
            display: none;
          "
          id="seat-warning"
        >
          ⚠️ 警告：若選定此位置，直到上餐完畢前，無法再更換位置。
        </p>
        <button class="btn" id="btn-confirm-seat" style="display: none">
          確認並下一步
        </button>
        <button class="btn outline" onclick="showPage('p-zones')">
          返回區域總覽
        </button>
      </div>

      <!-- 頁面 5: 點餐 -->
      <div id="p-menu" class="page">
        <h2>餐點選擇</h2>
        <p
          style="
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-bottom: 20px;
          "
        >
          規則：任選兩杯飲品 或 一飲一餐
        </p>
        <h3>飲品 Drinks</h3>
        <div id="menu-drinks"></div>
        <h3>餐點 Food</h3>
        <div id="menu-foods"></div>

        <!-- 備註區 -->
        <div style="margin-top: 30px; margin-bottom: 20px">
          <h3 style="font-size: 16px; margin-bottom: 10px">備註</h3>
          <textarea
            id="order-note"
            style="
              width: 100%;
              min-height: 80px;
              padding: 12px;
              background: #333;
              color: white;
              border: 1px solid #444;
              border-radius: 6px;
              box-sizing: border-box;
              font-size: 14px;
              font-family: inherit;
              resize: vertical;
            "
          ></textarea>
        </div>

        <div style="margin-top: 30px; text-align: center">
          <p>
            目前選擇：<span id="select-count-drink">0</span> 飲 /
            <span id="select-count-food">0</span> 餐
          </p>
          <button class="btn" onclick="submitOrder()">確認送出</button>
          <button class="btn outline" onclick="showPage('p-seat')">
            上一步 (重選座位)
          </button>
        </div>
      </div>

      <!-- 頁面 6: 完成 -->
      <div id="p-done" class="page">
        <div
          style="
            text-align: center;
            margin-top: 50vh;
            transform: translateY(-50%);
          "
        >
          <h1 style="color: var(--accent-glow)">I 人夜店<br />歡迎您</h1>
          <p style="line-height: 2">
            謝謝今天的您出現在這裡<br />讓我們靜嗨一整夜吧
          </p>
          <br />
          <p style="font-size: 12px; color: #666">
            (請在座位上稍候，餐點將送至您的座位)
          </p>
          <br />
          <button class="btn outline" onclick="checkAndGoToZones()">
            重回座位區
          </button>
        </div>
      </div>

      <!-- 休息中頁面 -->
      <div id="p-maintenance" class="page">
        <div
          style="
            text-align: center;
            margin-top: 50vh;
            transform: translateY(-50%);
          "
        >
          <h1 style="color: var(--accent-glow); font-size: 48px">
            I 人夜店<br />休息中
          </h1>
        </div>

        <!-- Staff 入口 -->
        <div class="staff-entry">
          <span class="staff-link" onclick="promptAdmin()">Staff Only</span>
        </div>
      </div>

      <!-- 後台管理頁面 -->
      <div id="p-admin" class="page">
        <h2>後台管理</h2>

        <!-- 功能 1: 即時訂單 -->
        <div
          style="
            background: #222;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <h3 style="margin-top: 0">即時訂單列表</h3>
            <div style="display: flex; gap: 5px; align-items: center">
              <button
                id="filter-all"
                class="stock-btn active"
                onclick="filterOrders('all')"
                style="font-size: 11px; padding: 4px 8px"
              >
                全部
              </button>
              <button
                id="filter-pending"
                class="stock-btn"
                onclick="filterOrders('pending')"
                style="font-size: 11px; padding: 4px 8px"
              >
                待出餐
              </button>
              <button
                id="filter-served"
                class="stock-btn"
                onclick="filterOrders('served')"
                style="font-size: 11px; padding: 4px 8px"
              >
                已出餐
              </button>
            </div>
          </div>
          <div
            id="admin-orders"
            style="
              max-height: 300px;
              overflow-y: auto;
              scrollbar-width: none;
              -ms-overflow-style: none;
            "
            class="hide-scrollbar"
          ></div>
        </div>

        <!-- 功能 3: 餐點庫存 -->
        <div
          style="
            background: #222;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin-top: 0">餐點庫存管理</h3>
          <!-- <p style="text-align: center; font-size: 12px; color: #aaa">
            綠色=供應中 / 灰色=已售完
          </p> -->
          <div
            id="admin-stock-list"
            style="display: flex; flex-wrap: wrap; gap: 5px"
          ></div>
        </div>

        <!-- 功能 0: 系統管理選單 -->
        <div
          style="
            background: #222;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin-top: 0">系統管理</h3>
          <div
            style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px"
          >
            <button
              class="btn outline"
              onclick="toggleMaintenancePanel()"
              id="maintenance-toggle-btn"
              style="
                flex: 1;
                min-width: 120px;
                padding: 10px;
                font-size: 13px;
                margin: 0;
              "
            >
              ⚙️ 前台開關
            </button>
            <button
              class="btn outline"
              onclick="toggleSeatsZonesPanel()"
              id="seats-zones-toggle-btn"
              style="
                flex: 1;
                min-width: 120px;
                padding: 10px;
                font-size: 13px;
                margin: 0;
              "
            >
              🪑 位置與區域
            </button>
            <button
              class="btn outline"
              onclick="toggleNamesPanel()"
              id="names-toggle-btn"
              style="
                flex: 1;
                min-width: 120px;
                padding: 10px;
                font-size: 13px;
                margin: 0;
              "
            >
              📝 報到名單
            </button>
            <button
              class="btn"
              id="export-excel-btn"
              style="
                flex: 1;
                min-width: 120px;
                padding: 10px;
                font-size: 13px;
                margin: 0;
              "
            >
              📊 匯出 Excel
            </button>
            <button
              class="btn danger"
              onclick="adminClearUsers()"
              style="
                flex: 1;
                min-width: 120px;
                padding: 10px;
                font-size: 13px;
                margin: 0;
              "
            >
              🔴 重置活動
            </button>
          </div>

          <!-- 前台開關面板 -->
          <div
            id="maintenance-panel"
            style="
              display: none;
              margin-top: 15px;
              padding: 15px;
              background: #1a1a24;
              border-radius: 6px;
              border: 1px solid #333;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div style="text-align: left; flex: 1">
                <h4
                  style="margin: 0 0 5px 0; font-size: 14px; text-align: left"
                >
                  前台開關
                </h4>
                <p
                  style="
                    font-size: 12px;
                    color: #aaa;
                    margin: 0;
                    text-align: left;
                  "
                >
                  關閉前台時，訪客將看到「休息中」頁面
                </p>
              </div>
              <label
                style="
                  position: relative;
                  display: inline-block;
                  width: 60px;
                  height: 30px;
                  cursor: pointer;
                "
              >
                <input
                  type="checkbox"
                  id="maintenance-toggle"
                  onchange="toggleMaintenance()"
                  style="opacity: 0; width: 0; height: 0"
                />
                <span
                  id="maintenance-slider"
                  style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: #444;
                    border-radius: 30px;
                    transition: 0.3s;
                  "
                >
                  <span
                    id="maintenance-slider-thumb"
                    style="
                      position: absolute;
                      content: '';
                      height: 24px;
                      width: 24px;
                      left: 3px;
                      bottom: 3px;
                      background-color: white;
                      border-radius: 50%;
                      transition: 0.3s;
                    "
                  ></span>
                </span>
              </label>
            </div>
            <p
              id="maintenance-status"
              style="
                text-align: center;
                font-size: 12px;
                color: #888;
                margin-top: 10px;
                margin-bottom: 0;
              "
            >
              狀態：前台正常運作
            </p>
          </div>

          <!-- 位置與區域管理面板 -->
          <div
            id="seats-zones-panel"
            style="
              display: none;
              margin-top: 15px;
              padding: 15px;
              background: #1a1a24;
              border-radius: 6px;
              border: 1px solid #333;
            "
          >
            <div
              style="
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-bottom: 15px;
              "
            >
              <button
                class="btn"
                onclick="showAllSeatsModal()"
                style="
                  flex: 1;
                  min-width: 150px;
                  padding: 12px;
                  font-size: 14px;
                  margin: 0;
                "
              >
                🪑 查看所有座位狀況
              </button>
              <button
                class="btn outline"
                onclick="toggleZonesList()"
                id="zones-toggle-btn"
                style="
                  flex: 1;
                  min-width: 150px;
                  padding: 12px;
                  font-size: 14px;
                  margin: 0;
                "
              >
                ✏️ 區域內容管理
              </button>
            </div>
            <div
              id="admin-zones-list"
              style="
                display: none;
                max-height: 400px;
                overflow-y: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
              "
              class="hide-scrollbar"
            ></div>
          </div>

          <!-- 新增報到名單面板 -->
          <div
            id="names-panel"
            style="
              display: none;
              margin-top: 15px;
              padding: 15px;
              background: #1a1a24;
              border-radius: 6px;
              border: 1px solid #333;
            "
          >
            <h4 style="margin: 0 0 10px 0; font-size: 14px">新增報到名單</h4>
            <textarea
              id="admin-names"
              placeholder="輸入名字，一行一個"
              style="
                width: 100%;
                height: 80px;
                background: #333;
                color: white;
                border: 1px solid #444;
                padding: 10px;
                box-sizing: border-box;
              "
            ></textarea>
            <button
              class="btn"
              onclick="adminAddUsers()"
              style="
                margin-top: 10px;
                padding: 10px;
                font-size: 14px;
                width: 100%;
              "
            >
              更新名單
            </button>
          </div>
        </div>

        <button class="btn outline" onclick="logoutAdmin()">登出後台</button>
      </div>
    </div>

    <!-- 引入 Firebase SDK -->
    <script type="module" src="app.js"></script>
  </body>
</html>
